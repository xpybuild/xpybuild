

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>xpybuild.targets.java &mdash; xpybuild v4.0 4.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> xpybuild v4.0
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../autodocgen/xpybuild.html">xpybuild</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Change Log</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">xpybuild v4.0</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>xpybuild.targets.java</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for xpybuild.targets.java</h1><div class="highlight"><pre>
<span></span><span class="c1"># xpyBuild - eXtensible Python-based Build System</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2013 - 2017, 2019 Software AG, Darmstadt, Germany and/or its licensors</span>
<span class="c1">#</span>
<span class="c1">#   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1">#   you may not use this file except in compliance with the License.</span>
<span class="c1">#   You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#       http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#   Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#   distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1">#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1">#   See the License for the specific language governing permissions and</span>
<span class="c1">#   limitations under the License.</span>
<span class="c1">#</span>
<span class="c1"># $Id: java.py 301527 2017-02-06 15:31:43Z matj $</span>
<span class="c1">#</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Contains targets for building and documenting Java applications. </span>

<span class="sd">The main target in this module is `xpybuild.targets.java.Jar`.</span>

<span class="sd">The directory containing the JDK is identified by the option ``java.home``. </span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">inspect</span><span class="o">,</span> <span class="nn">os.path</span><span class="o">,</span> <span class="nn">shutil</span>

<span class="kn">from</span> <span class="nn">xpybuild.buildcommon</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">xpybuild.basetarget</span> <span class="kn">import</span> <span class="n">BaseTarget</span><span class="p">,</span> <span class="n">targetNameToUniqueId</span>
<span class="kn">from</span> <span class="nn">xpybuild.propertysupport</span> <span class="kn">import</span> <span class="n">defineOption</span>
<span class="kn">from</span> <span class="nn">xpybuild.pathsets</span> <span class="kn">import</span> <span class="n">PathSet</span><span class="p">,</span> <span class="n">FilteredPathSet</span><span class="p">,</span> <span class="n">BasePathSet</span>
<span class="kn">from</span> <span class="nn">xpybuild.utils.fileutils</span> <span class="kn">import</span> <span class="n">mkdir</span><span class="p">,</span> <span class="n">deleteDir</span><span class="p">,</span> <span class="n">openForWrite</span><span class="p">,</span> <span class="n">normLongPath</span>
<span class="kn">from</span> <span class="nn">xpybuild.utils.java</span> <span class="kn">import</span> <span class="n">jar</span><span class="p">,</span> <span class="n">javac</span><span class="p">,</span> <span class="n">create_manifest</span><span class="p">,</span> <span class="n">javadoc</span><span class="p">,</span> <span class="n">signjar</span>
<span class="kn">from</span> <span class="nn">xpybuild.utils.flatten</span> <span class="kn">import</span> <span class="n">flatten</span>
<span class="kn">from</span> <span class="nn">xpybuild.utils.outputhandler</span> <span class="kn">import</span> <span class="n">ProcessOutputHandler</span>
<span class="kn">from</span> <span class="nn">xpybuild.utils.buildexceptions</span> <span class="kn">import</span> <span class="n">BuildException</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">collections</span>

<span class="c1"># Options specific to this target</span>
<span class="n">defineOption</span><span class="p">(</span><span class="s1">&#39;jar.manifest.classpathAppend&#39;</span><span class="p">,</span> <span class="p">[])</span>
<span class="n">defineOption</span><span class="p">(</span><span class="s1">&#39;javac.logs&#39;</span><span class="p">,</span> <span class="s1">&#39;$</span><span class="si">{BUILD_WORK_DIR}</span><span class="s1">/javac_logs&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_isJavaFile</span><span class="p">(</span><span class="n">p</span><span class="p">):</span> <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.java&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="SignJars"><a class="viewcode-back" href="../../../autodocgen/xpybuild.targets.java.html#xpybuild.targets.java.SignJars">[docs]</a><span class="k">class</span> <span class="nc">SignJars</span><span class="p">(</span><span class="n">BaseTarget</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot; Copy jars into a target directory and sign them with the supplied keystore, optionally also updating their manifests. </span>
<span class="sd">	</span>
<span class="sd">	Additional command line arguments can be passed to ``signjars`` using the option ``jarsigner.options`` (default ``[]``). </span>
<span class="sd">	</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">jars</span><span class="p">,</span> <span class="n">keystore</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">storepass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manifestDefaults</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; </span>
<span class="sd">		@param output: The output directory in which to put the signed jars</span>

<span class="sd">		@param jars: The list (or PathSet) of input jars to copy and sign</span>

<span class="sd">		@param keystore: The path to the keystore</span>

<span class="sd">		@param alias: The alias for the keystore (optional)</span>

<span class="sd">		@param storepass: The password for the store file (optional)</span>

<span class="sd">		@param manifestDefaults: a dictionary of manifest entries to add to the existing manifest.mf file</span>
<span class="sd">		of each jar before signing.  Entries in this dictionary will be ignored if the same entry</span>
<span class="sd">		is found in the original manifest.mf file already.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">jars</span> <span class="o">=</span> <span class="n">PathSet</span><span class="p">(</span><span class="n">jars</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">keystore</span> <span class="o">=</span> <span class="n">keystore</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">alias</span> <span class="o">=</span> <span class="n">alias</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">storepass</span> <span class="o">=</span> <span class="n">storepass</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">manifestDefaults</span> <span class="o">=</span> <span class="n">manifestDefaults</span>
		<span class="n">BaseTarget</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">jars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keystore</span><span class="p">])</span>

	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">keystore</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">expandPropertyValues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keystore</span><span class="p">)</span>
		<span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>

		<span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jars</span><span class="o">.</span><span class="n">resolveWithDestinations</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
			<span class="k">if</span> <span class="s1">&#39;..&#39;</span> <span class="ow">in</span> <span class="n">dest</span><span class="p">:</span>
					<span class="c1"># to avoid people abusing this to copy files outside the dest directory!</span>
					<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;This target does not permit destination paths to contain &quot;..&quot; relative path expressions&#39;</span><span class="p">)</span>

			<span class="k">try</span><span class="p">:</span>
				<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
					<span class="k">with</span> <span class="n">openForWrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">dest</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">d</span><span class="p">:</span>
						<span class="n">d</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

				<span class="n">shutil</span><span class="o">.</span><span class="n">copystat</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>
				
				<span class="c1"># When we re-jar with the user specified manifest entries, jar will complain</span>
				<span class="c1"># about duplicate attributes IF the original MANIFEST.MF already has those entries.</span>
				<span class="c1"># This is happening for latest version of SL where Application-Name, Permission etc</span>
				<span class="c1"># were already there.</span>
				<span class="c1">#</span>
				<span class="c1"># The block of code below will first extract the original MANIFEST.MF from the source</span>
				<span class="c1"># jar file, read all manifest entry to a list.  When constructing the new manifest entries,</span>
				<span class="c1"># make sure the old MANIFEST.MF doesn&#39;t have that entry before putting the new manifest entry</span>
				<span class="c1"># to the list.  This will avoid the duplicate attribute error.</span>
				<span class="c1">#  </span>
			
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">manifestDefaults</span><span class="p">:</span>
					
					<span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
					
					<span class="c1"># read each line of MANIFEST.MF of the original jar and put them in lines</span>
					<span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
						<span class="n">lst</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">infolist</span><span class="p">()</span>
						<span class="k">for</span> <span class="n">zi</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
							<span class="n">fn</span> <span class="o">=</span> <span class="n">zi</span><span class="o">.</span><span class="n">filename</span>
							<span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;manifest.mf&#39;</span><span class="p">):</span>
								<span class="k">try</span><span class="p">:</span>
									<span class="n">manifest_txt</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">zi</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;strict&#39;</span><span class="p">)</span>
								<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
									<span class="k">raise</span> <span class="n">BuildException</span><span class="p">(</span><span class="s1">&#39;Failed reading the manifest file </span><span class="si">%s</span><span class="s1"> with exception:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

								<span class="c1"># if we have all manifest text, parse and save each line</span>
								<span class="k">if</span> <span class="n">manifest_txt</span><span class="p">:</span>
									<span class="c1"># CR LF | LF | CR  can be there as line feed and hence the code below</span>
									<span class="n">lines</span> <span class="o">=</span> <span class="n">manifest_txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
										
								<span class="c1"># done</span>
								<span class="k">break</span>
						
					
					<span class="n">original_entries</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># to ensure we don&#39;t overwrite/duplicate these</span>
					<span class="c1"># populate the manifest_entries with original values from original manifest</span>
					<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
						<span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">l</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">l</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">):</span> <span class="c1"># ignore continuation lines etc because keys are all we care about</span>
							<span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
							<span class="n">original_entries</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
					
					<span class="c1"># build up a list of the new manifest entries (will be merged into any existing manifest by jar)</span>
					<span class="n">manifest_entries</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
					<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">manifestDefaults</span><span class="p">:</span>
						<span class="c1"># if entry isn&#39;t there yet, add to the list</span>
						<span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">original_entries</span><span class="p">:</span>
							<span class="n">manifest_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">expandPropertyValues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manifestDefaults</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
		
					<span class="c1"># create the manifest file</span>
					<span class="c1"># we want to add the manifest entries explicitly specified here but </span>
					<span class="c1"># NOT the &#39;default&#39; manifest entries we usually add, since these </span>
					<span class="c1"># are likely to have been set already, and we do not want duplicates</span>
					<span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workDir</span><span class="p">)</span>
					<span class="n">manifest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workDir</span><span class="p">,</span> <span class="s2">&quot;MANIFEST.MF&quot;</span><span class="p">)</span> <span class="c1"># manifest file</span>

					<span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
					<span class="n">options</span><span class="p">[</span><span class="s1">&#39;jar.manifest.defaults&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
					<span class="n">create_manifest</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">manifest_entries</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
	
					<span class="c1"># update the EXISTING jar file with the new manifest entries, which will be merged into </span>
					<span class="c1"># existing manifest by the jar tool</span>
					<span class="n">jar</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">dest</span><span class="p">),</span> <span class="n">manifest</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
	
				<span class="n">signjar</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">dest</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">keystore</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span> <span class="n">storepass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">storepass</span><span class="p">,</span> 
					<span class="n">outputHandler</span><span class="o">=</span><span class="n">ProcessOutputHandler</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;signjars&#39;</span><span class="p">,</span> <span class="n">treatStdErrAsErrors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>
			<span class="k">except</span> <span class="n">BuildException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">BuildException</span><span class="p">(</span><span class="s1">&#39;Error processing </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dest</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="Javac"><a class="viewcode-back" href="../../../autodocgen/xpybuild.targets.java.html#xpybuild.targets.java.Javac">[docs]</a><span class="k">class</span> <span class="nc">Javac</span><span class="p">(</span><span class="n">BaseTarget</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot; Compile Java classes to a directory (without creating a ``.jar``). </span>
<span class="sd">	</span>
<span class="sd">	Example usage::</span>
<span class="sd">	</span>
<span class="sd">		Javac(&#39;${OUTPUT_DIR}/myclasses/&#39;, </span>
<span class="sd">			# FindPaths walks a directory tree, supporting complex ant-style globbing patterns for include/exclude</span>
<span class="sd">			compile=[</span>
<span class="sd">				FindPaths(&#39;./src/&#39;, excludes=[&#39;**/VersionConstants.java&#39;]), </span>
<span class="sd">				&#39;${BUILD_WORK_DIR}/filtered-java-src/VersionConstants.java&#39;,</span>
<span class="sd">			],</span>
<span class="sd">			</span>
<span class="sd">			# DirBasedPathSet statically lists dependent paths under a directory</span>
<span class="sd">			classpath=[DirBasedPathSet(&#39;${MY_DEPENDENT_LIBRARY_DIR}/&#39;, &#39;mydep-api.jar&#39;, &#39;mydep-core.jar&#39;)],</span>
<span class="sd">		)</span>

<span class="sd">	The following options can be set with ``Javac(...).option(key, value)`` </span>
<span class="sd">	or `xpybuild.propertysupport.setGlobalOption()` to customize the compilation process:</span>
<span class="sd">		</span>
<span class="sd">		- ``javac.warningsAsErrors: bool`` Make the build fail if any warnings are detected. </span>
<span class="sd">		- ``javac.debug = False`` Include debug information (line numbers) in the compiled ``.class`` files. </span>
<span class="sd">		- ``javac.encoding = &quot;ASCII&quot;`` The character encoding for ``.java`` source files. </span>
<span class="sd">		- ``javac.source = &quot;&quot;`` The ``.java`` source compliance level. </span>
<span class="sd">		- ``javac.target = &quot;&quot;`` The ``.class`` compliance level. </span>
<span class="sd">		- ``javac.options = []`` A list of extra options to pass to ``javac``. </span>
<span class="sd">		- ``javac.logs = &quot;${BUILD_WORK_DIR}/javac_logs&quot;`` The directory in which errors/warnings from ``javac`` will be written. </span>
<span class="sd">		- ``javac.outputHandlerFactory = JavacProcessOutputHandler`` The class used to parse and handle error/warning messages. </span>
<span class="sd">	</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="nb">compile</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="n">classpath</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="nb">compile</span><span class="p">,</span> <span class="n">classpath</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; </span>
<span class="sd">		@param output: output dir for class files</span>

<span class="sd">		@param compile: PathSet (or list)  of things to compile</span>

<span class="sd">		@param classpath: PathSet (or list) of things to be on the classpath</span>

<span class="sd">		@param options: [DEPRECATED - use .option() instead]</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">compile</span> <span class="o">=</span> <span class="n">FilteredPathSet</span><span class="p">(</span><span class="n">_isJavaFile</span><span class="p">,</span> <span class="n">PathSet</span><span class="p">(</span><span class="nb">compile</span><span class="p">))</span>
			
		<span class="bp">self</span><span class="o">.</span><span class="n">classpath</span> <span class="o">=</span> <span class="n">PathSet</span><span class="p">(</span><span class="n">classpath</span><span class="p">)</span>
		
		<span class="n">BaseTarget</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">classpath</span><span class="p">])</span>
		<span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
		<span class="c1"># make sure outputdir exists</span>
		<span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

		<span class="c1"># create the classpath, sorting within PathSet (for determinism), but retaining original order of </span>
		<span class="c1"># PathSet elements in the list</span>
		<span class="n">classpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classpath</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">context</span><span class="p">))</span> 

		<span class="c1"># compile everything</span>
		<span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s1">&#39;javac.logs&#39;</span><span class="p">))</span>
		<span class="n">javac</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="n">classpath</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="n">logbasename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;javac.logs&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">targetNameToUniqueId</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">targetname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">workDir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workDir</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">getHashableImplicitInputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
		<span class="c1"># changes in the manifest text should cause a rebuild</span>
		<span class="c1"># for now, don&#39;t bother factoring global jar.manifest.defaults option </span>
		<span class="c1"># in here (it&#39;ll almost never change anyway)</span>
		<span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Javac</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">getHashableImplicitInputs</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="o">+</span> <span class="nb">sorted</span><span class="p">([</span>
			<span class="s1">&#39;option: </span><span class="si">%s</span><span class="s1"> = &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
				<span class="k">if</span> <span class="n">v</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;javac.&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;java.home&#39;</span><span class="p">)])</span></div>

<div class="viewcode-block" id="Jar"><a class="viewcode-back" href="../../../autodocgen/xpybuild.targets.java.html#xpybuild.targets.java.Jar">[docs]</a><span class="k">class</span> <span class="nc">Jar</span><span class="p">(</span><span class="n">BaseTarget</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot; Create a jar, first compiling some Java classes, then packing it all up as a ``.jar``. </span>
<span class="sd">	</span>
<span class="sd">	Example usage::</span>
<span class="sd">	</span>
<span class="sd">		Javac(&#39;${OUTPUT_DIR}/myapp.jar&#39;, </span>
<span class="sd">			# FindPaths walks a directory tree, supporting complex ant-style globbing patterns for include/exclude</span>
<span class="sd">			compile=[</span>
<span class="sd">				FindPaths(&#39;./src/&#39;, excludes=[&#39;**/VersionConstants.java&#39;]), </span>
<span class="sd">				&#39;${BUILD_WORK_DIR}/filtered-java-src/VersionConstants.java&#39;,</span>
<span class="sd">			],</span>
<span class="sd">			</span>
<span class="sd">			# DirBasedPathSet statically lists dependent paths under a directory</span>
<span class="sd">			classpath=[DirBasedPathSet(&#39;${MY_DEPENDENT_LIBRARY_DIR}/&#39;, &#39;mydep-api.jar&#39;, &#39;mydep-core.jar&#39;)],</span>
<span class="sd">			</span>
<span class="sd">			# Specify Jar-specific key/values for the MANIFEST.MF (in addition to any set globally via options)</span>
<span class="sd">			manifest={&#39;Implementation-Title&#39;:&#39;My Amazing Java Application&#39;}, </span>
<span class="sd">			</span>
<span class="sd">			package=FindPaths(&#39;resources/&#39;, includes=&#39;**/*.properties&#39;),</span>
<span class="sd">		)</span>

<span class="sd">		setGlobalOption(&#39;jar.manifest.defaults&#39;, {&#39;Implementation-Version&#39;: &#39;${APP_VERSION}&#39;, &#39;Implementation-Vendor&#39;: &#39;My Company&#39;})</span>

<span class="sd">		</span>
<span class="sd">	In addition to the options listed on the `Javac` target, the following options can be set when </span>
<span class="sd">	creating a Jar, using ``Jar(...).option(key, value)`` or `xpybuild.propertysupport.setGlobalOption()`:</span>
<span class="sd">		</span>
<span class="sd">		- ``jar.manifest.defaults = {}`` Default key/value pairs (e.g. version number) to include in the ``MANIFEST.MF`` of every jar. </span>
<span class="sd">		- ``jar.manifest.classpathAppend = []`` Add additional classpath entries to the ``MANIFEST.MF`` which are needed at runtime but not during compilation. </span>
<span class="sd">		- ``jar.options = []`` A list of extra options to pass to ``jar``. </span>

<span class="sd">	@param jar: path to jar to create.</span>

<span class="sd">	@param compile: PathSet (or list)  of things to compile.</span>

<span class="sd">	@param classpath: PathSet (or list) of things to be on the classpath; </span>
<span class="sd">		destination mapping indicates how they will appear in the manifest.</span>

<span class="sd">	@param manifest: Typically a map of ``MANIFEST.MF`` entries (can be empty) such as::</span>
<span class="sd">	</span>
<span class="sd">			manifest={&#39;Implementation-Title&#39;:&#39;My Amazing Java Application&#39;}, </span>
<span class="sd">		</span>
<span class="sd">		Alternative, specify a string to get the manifest from a file, or ``None`` </span>
<span class="sd">		to disable manifest generation and just produce a normal zip. </span>

<span class="sd">	@param options: (deprecated - use ``.option()`` instead). </span>

<span class="sd">	@param package: PathSet (or list) of other files to include in the jar; </span>
<span class="sd">		destination mapping indicates where they will appear in the jar.</span>
<span class="sd">	</span>
<span class="sd">	@param preserveManifestFormatting: an advanced option that prevents the jar tool from </span>
<span class="sd">		reformatting the specified manifest file to comply with Java conventions </span>
<span class="sd">		(also prevents manifest merging if jar already exists).</span>

<span class="sd">	&quot;&quot;&quot;</span>
	<span class="nb">compile</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="n">classpath</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="n">package</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="n">manifest</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jar</span><span class="p">,</span> <span class="nb">compile</span><span class="p">,</span> <span class="n">classpath</span><span class="p">,</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">preserveManifestFormatting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">compile</span> <span class="o">=</span> <span class="n">FilteredPathSet</span><span class="p">(</span><span class="n">_isJavaFile</span><span class="p">,</span> <span class="n">PathSet</span><span class="p">(</span><span class="nb">compile</span><span class="p">))</span> <span class="k">if</span> <span class="nb">compile</span> <span class="k">else</span> <span class="kc">None</span>
			
		<span class="bp">self</span><span class="o">.</span><span class="n">classpath</span> <span class="o">=</span> <span class="n">PathSet</span><span class="p">(</span><span class="n">classpath</span><span class="p">)</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">package</span> <span class="o">=</span> <span class="n">PathSet</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">manifest</span> <span class="o">=</span> <span class="n">manifest</span>
		<span class="n">BaseTarget</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jar</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">classpath</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="p">,</span> 
			<span class="n">manifest</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">])</span>
			
		<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">options</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">preserveManifestFormatting</span> <span class="o">=</span> <span class="n">preserveManifestFormatting</span>

	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
		<span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>

		<span class="c1"># make sure temp dir exists</span>
		<span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workDir</span><span class="p">)</span>

		<span class="n">classes</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workDir</span><span class="p">,</span> <span class="s2">&quot;classes&quot;</span><span class="p">)</span> <span class="c1"># output dir for classes</span>
		
		<span class="c1"># create the classpath, sorting within PathSet (for determinism), but retaining original order of </span>
		<span class="c1"># PathSet elements in the list</span>
		<span class="n">classpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classpath</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">context</span><span class="p">))</span> 

		<span class="c1"># compile everything</span>
		<span class="n">mkdir</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span> <span class="c1"># (need this for assembling other files to package later on, even if we don&#39;t do any javac)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">:</span>
			<span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s1">&#39;javac.logs&#39;</span><span class="p">))</span>
			<span class="n">javac</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="n">classpath</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">logbasename</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;javac.logs&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">targetNameToUniqueId</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">targetname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">workDir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workDir</span><span class="p">)</span>

		<span class="n">manifest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workDir</span><span class="p">,</span> <span class="s2">&quot;MANIFEST.MF&quot;</span><span class="p">)</span> <span class="c1"># manifest file</span>
	
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manifest</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="n">manifest</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">getFullPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manifest</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">manifest</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">manifest</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="k">else</span><span class="p">:</span> <span class="c1"># generate one</span>
			<span class="c1"># rewrite property values in the manifest</span>
			<span class="n">manifest_entries</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">manifest</span><span class="p">:</span>
				<span class="n">manifest_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">expandPropertyValues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manifest</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
	
			<span class="c1"># determine classpath for manifest</span>
			<span class="n">classpath_entries</span> <span class="o">=</span> <span class="p">[]</span>
			
			<span class="k">if</span> <span class="s2">&quot;Class-path&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">manifest_entries</span><span class="p">:</span> <span class="c1"># assuming it wasn&#39;t hardcoded, set it here</span>
				<span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">classpath</span><span class="o">.</span><span class="n">resolveWithDestinations</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
					<span class="c1"># we definitely do want to support use of &quot;..&quot; in destinations here, it can be very useful</span>
					<span class="n">classpath_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
				<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;jar.manifest.classpathAppend&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">),</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;jar.manifest.classpathAppend&#39;</span><span class="p">]</span> <span class="c1"># must not be a string</span>
				<span class="n">classpath_entries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;jar.manifest.classpathAppend&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">[])</span>
				
				<span class="c1"># need to always use / not \ for these to be valid</span>
				<span class="n">classpath_entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">classpath_entries</span> <span class="k">if</span> <span class="n">p</span><span class="p">]</span>
				
				<span class="k">if</span> <span class="n">classpath_entries</span><span class="p">:</span>
					<span class="n">manifest_entries</span><span class="p">[</span><span class="s2">&quot;Class-path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">classpath_entries</span><span class="p">)</span> <span class="c1"># include the classpath from here</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">manifest_entries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Class-path&#39;</span><span class="p">):</span> <span class="c1"># suppress this element entirely if not needed, otherwise there would be no way to have an empty classpath</span>
				<span class="n">manifest_entries</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Class-path&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
			
			<span class="c1"># create the manifest file</span>
			<span class="n">create_manifest</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">manifest_entries</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

		<span class="c1"># copy in the additional things to include</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">resolveWithDestinations</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
			<span class="k">if</span> <span class="s1">&#39;..&#39;</span> <span class="ow">in</span> <span class="n">dest</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;This target does not permit packaged destination paths to contain &quot;..&quot; relative path expressions&#39;</span><span class="p">)</span>
			<span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">dest</span><span class="p">)))</span>
			<span class="n">destpath</span> <span class="o">=</span> <span class="n">normLongPath</span><span class="p">(</span><span class="n">classes</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">dest</span><span class="p">)</span>
			<span class="n">srcpath</span> <span class="o">=</span> <span class="n">normLongPath</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

			<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">srcpath</span><span class="p">):</span>
				<span class="n">mkdir</span><span class="p">(</span><span class="n">destpath</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">srcpath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
					<span class="k">with</span> <span class="n">openForWrite</span><span class="p">(</span><span class="n">destpath</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">d</span><span class="p">:</span>
						<span class="n">d</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

		<span class="c1"># create the jar</span>
		<span class="n">jar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">manifest</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">preserveManifestFormatting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">preserveManifestFormatting</span><span class="p">,</span> 
			<span class="n">outputHandler</span><span class="o">=</span><span class="n">ProcessOutputHandler</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;jar&#39;</span><span class="p">,</span> <span class="n">treatStdErrAsErrors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">))</span>

	<span class="k">def</span> <span class="nf">getHashableImplicitInputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
		<span class="c1"># changes in the manifest text should cause a rebuild</span>
		<span class="c1"># for now, don&#39;t bother factoring global jar.manifest.defaults option </span>
		<span class="c1"># in here (it&#39;ll almost never change anyway)</span>
		<span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Jar</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">getHashableImplicitInputs</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span>
			<span class="s1">&#39;manifest = &#39;</span><span class="o">+</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">expandPropertyValues</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manifest</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manifest</span><span class="p">,</span><span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> 
				<span class="nb">str</span><span class="p">({</span><span class="n">context</span><span class="o">.</span><span class="n">expandPropertyValues</span><span class="p">(</span><span class="n">k</span><span class="p">):</span><span class="n">context</span><span class="o">.</span><span class="n">expandPropertyValues</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">manifest</span><span class="o">.</span><span class="n">items</span><span class="p">()})),</span>
			<span class="s1">&#39;classpath = &#39;</span><span class="o">+</span><span class="n">context</span><span class="o">.</span><span class="n">expandPropertyValues</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classpath</span><span class="p">)),</span> <span class="c1"># because classpath destinations affect manifest</span>
			<span class="p">]</span><span class="o">+</span><span class="p">([</span><span class="s1">&#39;preserveManifestFormatting = true&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preserveManifestFormatting</span> <span class="k">else</span> <span class="p">[])</span>\
			<span class="o">+</span><span class="nb">sorted</span><span class="p">([</span><span class="s1">&#39;option: </span><span class="si">%s</span><span class="s1"> = &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
				<span class="k">if</span> <span class="n">v</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;javac.&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;jar.&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;java.home&#39;</span><span class="p">)])</span></div>

<div class="viewcode-block" id="Javadoc"><a class="viewcode-back" href="../../../autodocgen/xpybuild.targets.java.html#xpybuild.targets.java.Javadoc">[docs]</a><span class="k">class</span> <span class="nc">Javadoc</span><span class="p">(</span><span class="n">BaseTarget</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot; Creates Javadoc from a set of input files. </span>
<span class="sd">	</span>
<span class="sd">	The following options can be set with ``Javadoc(...).option(key, value)`` to customize the documentation process:</span>
<span class="sd">		</span>
<span class="sd">		- ``javadoc.title = &quot;Documentation&quot;`` The title. </span>
<span class="sd">		</span>
<span class="sd">		- ``javac.ignoreSourceFilesFromClasspath = False`` By default, Javadoc will parse any source .java files </span>
<span class="sd">		  present in the classpath in case they contain comments </span>
<span class="sd">		  that should be inherited by the source files being documented. If these files contain errors (such as missing </span>
<span class="sd">		  optional dependencies) it will cause Javadoc to fail. This option prevents the classpath from being searched </span>
<span class="sd">		  for source files (by setting -sourcepath to a non-existent directoryu), which avoids errors and may also speed </span>
<span class="sd">		  up the Javadoc generation. </span>

<span class="sd">		- ``javac.access = &quot;public&quot;`` Identifies which members and classes to include. </span>
<span class="sd">		</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destdir</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">classpath</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		@param destdir: directory to create docs in</span>

<span class="sd">		@param source: a set of files to build from</span>

<span class="sd">		@param classpath: a list of jars needed for the classpath</span>

<span class="sd">		@param options: [DEPRECATED - use .option() instead]</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">PathSet</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">classpath</span> <span class="o">=</span> <span class="n">PathSet</span><span class="p">(</span><span class="n">classpath</span><span class="p">)</span>
		<span class="n">BaseTarget</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destdir</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">classpath</span><span class="p">])</span>
		<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">options</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
		<span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>
		<span class="n">classpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classpath</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>
		<span class="n">javadoc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="n">classpath</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> 
			<span class="n">outputHandler</span><span class="o">=</span><span class="n">ProcessOutputHandler</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;javadoc&#39;</span><span class="p">,</span> <span class="n">treatStdErrAsErrors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">),</span> <span class="n">workDir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workDir</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">getHashableImplicitInputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
		<span class="c1"># changes in the manifest text should cause a rebuild</span>
		<span class="c1"># for now, don&#39;t bother factoring global jar.manifest.defaults option </span>
		<span class="c1"># in here (it&#39;ll almost never change anyway)</span>
		<span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Javadoc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">getHashableImplicitInputs</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="o">+</span> \
			<span class="nb">sorted</span><span class="p">([</span><span class="s1">&#39;option: </span><span class="si">%s</span><span class="s1"> = &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
				<span class="k">if</span> <span class="n">k</span> <span class="ow">and</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;javadoc.&#39;</span><span class="p">)])</span></div>
				
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019-2021, Ben Spiller and Matthew Johnson

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>xpybuild.basetarget &mdash; xpybuild v4.0 4.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> xpybuild v4.0
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../autodocgen/xpybuild.html">xpybuild</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Change Log</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">xpybuild v4.0</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>xpybuild.basetarget</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for xpybuild.basetarget</h1><div class="highlight"><pre>
<span></span><span class="c1"># xpyBuild - eXtensible Python-based Build System</span>
<span class="c1">#</span>
<span class="c1"># Contains the base classes for creating various kinds of target. </span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2013 - 2019 Software AG, Darmstadt, Germany and/or its licensors</span>
<span class="c1">#</span>
<span class="c1">#   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1">#   you may not use this file except in compliance with the License.</span>
<span class="c1">#   You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#       http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1">#   Unless required by applicable law or agreed to in writing, software</span>
<span class="c1">#   distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1">#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1">#   See the License for the specific language governing permissions and</span>
<span class="c1">#   limitations under the License.</span>
<span class="c1">#</span>
<span class="c1"># $Id: basetarget.py 301527 2017-02-06 15:31:43Z matj $</span>
<span class="c1">#</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Contains `xpybuild.basetarget.BaseTarget` which contains </span>
<span class="sd">methods such as `basetarget.BaseTarget.option`, `basetarget.BaseTarget.tags` for configuring the target instances </span>
<span class="sd">in your build files, and is also the base class for defining new targets. </span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">inspect</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">xpybuild.buildcommon</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">xpybuild.buildcontext</span>
<span class="kn">from</span> <span class="nn">xpybuild.buildcontext</span> <span class="kn">import</span> <span class="n">getBuildInitializationContext</span>
<span class="kn">import</span> <span class="nn">xpybuild.buildcontext</span>
<span class="kn">import</span> <span class="nn">xpybuild.utils.fileutils</span> <span class="k">as</span> <span class="nn">fileutils</span>
<span class="kn">from</span> <span class="nn">xpybuild.utils.flatten</span> <span class="kn">import</span> <span class="n">flatten</span><span class="p">,</span> <span class="n">getStringList</span>
<span class="kn">from</span> <span class="nn">xpybuild.utils.buildfilelocation</span> <span class="kn">import</span> <span class="n">BuildFileLocation</span>
<span class="kn">from</span> <span class="nn">xpybuild.utils.functors</span> <span class="kn">import</span> <span class="n">Composable</span>
<span class="kn">from</span> <span class="nn">xpybuild.utils.buildexceptions</span> <span class="kn">import</span> <span class="n">BuildException</span>
<span class="kn">from</span> <span class="nn">xpybuild.utils.fileutils</span> <span class="kn">import</span> <span class="n">openForWrite</span><span class="p">,</span> <span class="n">normLongPath</span><span class="p">,</span> <span class="n">mkdir</span>
<span class="kn">import</span> <span class="nn">xpybuild.utils.stringutils</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">xpybuild.propertysupport</span> <span class="kn">import</span> <span class="n">defineOption</span>

<div class="viewcode-block" id="BaseTarget"><a class="viewcode-back" href="../../autodocgen/xpybuild.basetarget.html#xpybuild.basetarget.BaseTarget">[docs]</a><span class="k">class</span> <span class="nc">BaseTarget</span><span class="p">(</span><span class="n">Composable</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot; The base class for all targets. </span>
<span class="sd">	</span>
<span class="sd">	.. rubric:: Configuring targets in your build files</span>
<span class="sd">	</span>
<span class="sd">	The following methods can be used to configure any target instance you add to a build file:</span>
<span class="sd">	</span>
<span class="sd">	.. autosummary ::</span>
<span class="sd">		option</span>
<span class="sd">		tags</span>
<span class="sd">		clearTags</span>
<span class="sd">		disableInFullBuild</span>
<span class="sd">		priority</span>

<span class="sd">	.. rubric:: Implementing a new target class</span>
<span class="sd">	</span>
<span class="sd">	If you are subclassing ``BaseTarget`` to create a new target class, you must implement `run`. </span>
<span class="sd">	</span>
<span class="sd">	In rare occasions you may also wish to override `clean`. The following methods are available for use by target </span>
<span class="sd">	subclasses, either at construction time (``__init__``) or at build time (during `run` or `clean`):</span>

<span class="sd">	.. autosummary ::</span>
<span class="sd">		registerImplicitInputOption</span>
<span class="sd">		registerImplicitInput</span>
<span class="sd">		getOption</span>
<span class="sd">		openFile</span>
<span class="sd">		targetNameToUniqueId</span>
<span class="sd">	</span>
<span class="sd">	This class provides several read-only attributes for use by subclasses.</span>

<span class="sd">	:ivar str name: The canonical name for the target (containing unsubstituted properties).</span>
<span class="sd">	</span>
<span class="sd">	:ivar str path: The resolved name with all properties variables expanded. This field is set only once the target is </span>
<span class="sd">		running or checking up-to-dateness but not during initialization phase when targets are initially constructed.</span>
<span class="sd">	</span>
<span class="sd">	:ivar dict options: A ``dict`` of the resolved options for this target. Can only be used once target is running or </span>
<span class="sd">		checking up-to-dateness but not during the initialization phase. See also `getOption()`.</span>
<span class="sd">	</span>
<span class="sd">	:ivar str workDir: A unique dedicated directory where this target can write temporary/working files.</span>

<span class="sd">	.. rubric:: Arguments for the BaseTarget __init__ constructor</span>

<span class="sd">	@param name: This target instance&#39;s unique name, which is the file or </span>
<span class="sd">		directory path which is created as a result of running this target. </span>
<span class="sd">		The target name may contain ``${...}`` properties (e.g. </span>
<span class="sd">		``${OUTPUT_DIR}/myoutputfile``), and must use only forward slashes ``/``. </span>
<span class="sd">		If the target builds a directory it must end with a forward slash. </span>
<span class="sd">	</span>
<span class="sd">	@param dependencies: The dependencies, which may need to be </span>
<span class="sd">		flattened/expanded by the build system; may be any combination of </span>
<span class="sd">		strings, `xpybuild.pathsets`` and lists, and may also contain </span>
<span class="sd">		unexpanded variables.</span>
<span class="sd">		</span>
<span class="sd">	.. rubric:: BaseTarget methods</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="c1"># to allow targets to be used in sets, override hash to ensure it&#39;s deterministic;</span>
	<span class="c1"># no need to override eq/ne, they use object identity which is already correct</span>
	<span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Uses the target name to generate a hash. Targets are required to produce unique outputs.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

	
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__getAttrImpl</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__returnOrRaiseIfNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__path</span><span class="p">,</span> <span class="s1">&#39;Target path has not yet been resolved by this phase of the build process: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="bp">self</span><span class="p">),</span>
			<span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__name</span><span class="p">,</span>
			<span class="s1">&#39;options&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__returnOrRaiseIfNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__optionsResolved</span><span class="p">,</span> <span class="s2">&quot;Cannot read the value of basetarget.targetOptions during the initialization phase of the build as the resolved option values are not yet available&quot;</span><span class="p">),</span>
			<span class="s1">&#39;workDir&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__workDir</span><span class="p">,</span>
			<span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
			<span class="s1">&#39;baseDir&#39;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">buildDir</span><span class="p">,</span>
		<span class="p">}</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">__optionsTargetOverridesUnresolved</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># for target-specific option overrides. for internal use (by buildcontext), do not use</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__optionsResolved</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># gets assigned during end of initialization phase</span>

		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="k">if</span> <span class="s1">&#39;//&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">BuildException</span><span class="p">(</span><span class="s1">&#39;Invalid target name: double slashes are not permitted: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">name</span><span class="p">)</span>
			<span class="k">if</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">BuildException</span><span class="p">(</span><span class="s1">&#39;Invalid target name: backslashes are not permitted: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">name</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__name</span> <span class="o">=</span> <span class="n">BaseTarget</span><span class="o">.</span><span class="n">_normalizeTargetName</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__path_src</span> <span class="o">=</span> <span class="n">name</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__tags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;full&#39;</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__priority</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># default so we can go bigger or smaller</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
		
		<span class="c1"># put the class first, since it results in better ordering (e.g. for errors)</span>
		<span class="c1"># use a space to delimit these to make it easier to copy to the clipboard by double-clicking</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__stringvalue</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s1">&gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
		
		<span class="n">init</span> <span class="o">=</span> <span class="n">getBuildInitializationContext</span><span class="p">()</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">init</span><span class="p">:</span> <span class="c1"># doc-test mode</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">BuildFileLocation</span><span class="p">(</span><span class="n">raiseOnError</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span> 
			<span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">BuildFileLocation</span><span class="p">(</span><span class="n">raiseOnError</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="n">init</span><span class="o">.</span><span class="n">registerTarget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="c1"># this can throw</span>

		<span class="c1"># should ensure changes to the build file cause a rebuild? probs no need</span>
		<span class="c1"># PathSet will perform all necessary flattening etc</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__dependencies</span> <span class="o">=</span> <span class="n">PathSet</span><span class="p">(</span><span class="n">dependencies</span><span class="p">)</span>
			
		<span class="bp">self</span><span class="o">.</span><span class="n">__path</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># set by _resolveTargetPath</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__workDir</span> <span class="o">=</span> <span class="kc">None</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">__registeredImplicitInputs</span> <span class="o">=</span> <span class="p">[]</span>
		
		<span class="c1"># aliases for pre-3.0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">addHashableImplicitInputOption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registerImplicitInputOption</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">addHashableImplicitInput</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registerImplicitInput</span>

	<span class="nd">@staticmethod</span>
	<span class="k">def</span> <span class="nf">_normalizeTargetName</span><span class="p">(</span><span class="n">name</span><span class="p">):</span> <span class="c1"># non-public method to ensure comparisons between target names are done consistently</span>
		<span class="k">if</span> <span class="n">xpybuild</span><span class="o">.</span><span class="n">buildcontext</span><span class="o">.</span><span class="n">_EXPERIMENTAL_NO_DOLLAR_PROPERTY_SYNTAX</span><span class="p">:</span> 
			<span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$${&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;__xpybuild_dollar_placeholder&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;${&#39;</span><span class="p">,</span> <span class="s1">&#39;{&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;__xpybuild_dollar_placeholder&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;$${&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">name</span>

	<span class="k">def</span> <span class="nf">__returnOrRaiseIfNone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">exceptionMessage</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">value</span>
		<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">exceptionMessage</span><span class="p">)</span>

	<span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="c1"># this is a hack to retain backwards compat for a few classes that rely on explicitly assigning to self.options</span>

		<span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;options&#39;</span><span class="p">:</span>
			<span class="c1"># make this a WARN at some point</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Target class &quot;</span><span class="si">%s</span><span class="s1">&quot; assigns to self.options which is deprecated - instead call .option(...) to set target options&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">value</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">__optionsTargetOverridesUnresolved</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

	<span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Getter for read-only attributes &quot;&quot;&quot;</span>
		<span class="c1"># nb this is not called for fields that have been set explicitly using self.X = ...</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getAttrImpl</span><span class="p">[</span><span class="n">name</span><span class="p">]()</span>
		<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;Unknown attribute </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">name</span><span class="p">)</span>

	<span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1"># string display name which is used for log statements etc</span>
		<span class="sd">&quot;&quot;&quot; Returns a display name including the target name and the target type (class) &quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__stringvalue</span>

	<span class="k">def</span> <span class="nf">resolveToString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		.. private:: There is usually no need for this to be called other than by the framework. 		</span>
<span class="sd">		Resolves this target&#39;s path and returns as a string. </span>
<span class="sd">		</span>
<span class="sd">		It is acceptable to call this while the build files are still being </span>
<span class="sd">		parsed (before the dependency checking phase), but an error will result </span>
<span class="sd">		if resolution depends on anything that has not yet been defined. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		
		<span class="c1"># implementing this allows targets to be used in Composeable expressions</span>
		
		<span class="c1"># if there&#39;s no explicit parent, default to ${OUTPUT_DIR} to stop </span>
		<span class="c1"># people accidentally writing to their source directories</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__path</span> <span class="c1"># cache it for consistency</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__path</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">getFullPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__path_src</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">getPropertyValue</span><span class="p">(</span><span class="s2">&quot;OUTPUT_DIR&quot;</span><span class="p">))</span>
		
		<span class="n">badchars</span> <span class="o">=</span> <span class="s1">&#39;&lt;&gt;:&quot;|?*&#39;</span> <span class="c1"># Windows bad characters; it&#39;s helpful to stop people using such characters on all OSes too since almost certainly not intended</span>
		<span class="n">foundbadchars</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__path</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">badchars</span><span class="p">]</span> <span class="c1"># (nb: ignore first 2 chars of absolute path which will necessarily contain a colon on Windows)</span>
		<span class="k">if</span> <span class="n">foundbadchars</span><span class="p">:</span> <span class="k">raise</span> <span class="n">BuildException</span><span class="p">(</span><span class="s1">&#39;Invalid character(s) &quot;</span><span class="si">%s</span><span class="s1">&quot; found in target name </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">foundbadchars</span><span class="p">)))),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__path</span><span class="p">))</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__path</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)):</span> <span class="k">raise</span> <span class="n">BuildException</span><span class="p">(</span><span class="s1">&#39;Target name must not end in a &quot;.&quot; or &quot; &quot;&#39;</span><span class="p">)</span> <span class="c1"># https://docs.microsoft.com/en-us/windows/win32/fileio/naming-a-file</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Resolved target name </span><span class="si">%s</span><span class="s1"> to canonical path </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__path</span>

	<span class="k">def</span> <span class="nf">_resolveTargetPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;.. private:: Internal method for resolving path from name, performing any </span>
<span class="sd">		required expansion etc. </span>
<span class="sd">		</span>
<span class="sd">		Do not override or call this method.</span>
<span class="sd">		</span>
<span class="sd">		@param context: The initialization context, with all properties and options fully defined. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">resolveToString</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

		<span class="c1"># do this early (before deps resolution) so it can be used for clean</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__workDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">getPropertyValue</span><span class="p">(</span><span class="s2">&quot;BUILD_WORK_DIR&quot;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/targets/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">targetNameToUniqueId</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
		
		<span class="c1"># take the opportunity to provide a merged set of options</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__optionsTargetOverridesUnresolved</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">__optionsResolved</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">_globalOptions</span> <span class="c1"># since is immutable so we can avoid a copy</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">__optionsResolved</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">_mergeListOfOptionDicts</span><span class="p">([</span><span class="n">context</span><span class="o">.</span><span class="n">_globalOptions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__optionsTargetOverridesUnresolved</span><span class="p">],</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_resolveUnderlyingDependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">rawdeps</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;.. private:: Internal method for resolving dependencies needed by this target, </span>
<span class="sd">		e.g. doing path expansion, globbing, etc. </span>
<span class="sd">		</span>
<span class="sd">		Do not override this method. This method should be invoked only once, </span>
<span class="sd">		by the scheduler. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># special option just for verify implementation, returning the real deps not the underlying deps</span>
		<span class="k">if</span> <span class="n">rawdeps</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dependencies</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
		
		<span class="c1"># don&#39;t think there&#39;s any value in caching this result</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dependencies</span><span class="o">.</span><span class="n">_resolveUnderlyingDependencies</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

<div class="viewcode-block" id="BaseTarget.run"><a class="viewcode-back" href="../../autodocgen/xpybuild.basetarget.html#xpybuild.basetarget.BaseTarget.run">[docs]</a>	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">xpybuild</span><span class="o">.</span><span class="n">buildcontext</span><span class="o">.</span><span class="n">BuildContext</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Called by xpybuild to request to target to run its build (all targets must implement this). </span>
<span class="sd">		</span>
<span class="sd">		This method is only called when up-to-date checking shows that the target must be built. </span>
<span class="sd">		It&#39;s possible that execution will show that the target did not really </span>
<span class="sd">		need to execute, in which case False should be returned.  </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;run() is not implemented yet for this target&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseTarget.clean"><a class="viewcode-back" href="../../autodocgen/xpybuild.basetarget.html#xpybuild.basetarget.BaseTarget.clean">[docs]</a>	<span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">xpybuild</span><span class="o">.</span><span class="n">buildcontext</span><span class="o">.</span><span class="n">BuildContext</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Called by xpybuild when the target should be deleted (can be overridden if needed). </span>
<span class="sd">		</span>
<span class="sd">		The default implementation will simply delete the target, and any target </span>
<span class="sd">		workdir, but can be overridden to delete additional temporary files if </span>
<span class="sd">		needed (shouldn&#39;t be).</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">workDir</span><span class="p">:</span>
				<span class="n">fileutils</span><span class="o">.</span><span class="n">deleteDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workDir</span><span class="p">)</span>
		<span class="k">finally</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Target clean is deleting directory: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
				<span class="n">fileutils</span><span class="o">.</span><span class="n">deleteDir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">fileutils</span><span class="o">.</span><span class="n">deleteFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaseTarget.registerImplicitInputOption"><a class="viewcode-back" href="../../autodocgen/xpybuild.basetarget.html#xpybuild.basetarget.BaseTarget.registerImplicitInputOption">[docs]</a>	<span class="k">def</span> <span class="nf">registerImplicitInputOption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">optionKey</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Target classes can call this from their ``__init__()`` to add the resolved value of the specified option(s) as </span>
<span class="sd">		&#39;implicit inputs&#39; of this target. </span>
<span class="sd">		</span>
<span class="sd">		This list will be written to disk after the target builds successfully, and compared with its recorded value </span>
<span class="sd">		when subsequently checking the up-to-date-ness of the target.</span>
<span class="sd">		This allows xpybuild to detect when the target should be rebuilt as a result of a change in options or property </span>
<span class="sd">		values (e.g. build number, release/debug mode etc), even if no dependencies have changed. </span>
<span class="sd">		</span>
<span class="sd">		Call this from the target&#39;s constructor, for each option that this target is affected by, </span>
<span class="sd">		or with a callable that dynamically selects from the defined options, e.g. based on a prefix. </span>
<span class="sd">		</span>
<span class="sd">		@param optionKey: the name of an option (as a string), </span>
<span class="sd">			or a callable that accepts an optionKey and dynamically decides which options to include, </span>
<span class="sd">			returning True if it should be included. For example::</span>
<span class="sd">		  </span>
<span class="sd">				self.registerImplicitInputOption(lambda optionKey: optionKey.startswith((&#39;java.&#39;, &#39;javac.&#39;)))</span>
<span class="sd">		</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">registerImplicitInput</span><span class="p">(</span><span class="k">lambda</span> <span class="n">context</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getMatchingOptions</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">optionKey</span><span class="p">))</span></div>

	<span class="k">def</span> <span class="nf">__getMatchingOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">optionKey</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">optionKey</span><span class="p">):</span>
			<span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="k">if</span> <span class="n">optionKey</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">optionKey</span><span class="p">]</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
			<span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="fm">__repr__</span><span class="o">.</span><span class="vm">__qualname__</span> <span class="o">==</span> <span class="s1">&#39;function.__repr__&#39;</span><span class="p">:</span> 
				<span class="n">value</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="vm">__qualname__</span> <span class="c1"># avoid 0x references for top-level functions (nb: doesn&#39;t affect lambas/nested functions)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">value</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
			<span class="c1">#assert &#39;0x&#39; not in value</span>
			<span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;option </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="BaseTarget.registerImplicitInput"><a class="viewcode-back" href="../../autodocgen/xpybuild.basetarget.html#xpybuild.basetarget.BaseTarget.registerImplicitInput">[docs]</a>	<span class="k">def</span> <span class="nf">registerImplicitInput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Target classes can call this from their ``__init__()`` to add the specified string line(s) as </span>
<span class="sd">		&#39;implicit inputs&#39; of this target. </span>
<span class="sd">		</span>
<span class="sd">		This list will be written to disk after the target builds successfully, and compared with its recorded value </span>
<span class="sd">		when subsequently checking the up-to-date-ness of the target.</span>
<span class="sd">		This allows xpybuild to detect when the target should be rebuilt as a result of a change in options or property </span>
<span class="sd">		values (e.g. build number, release/debug mode etc), even if no dependencies have changed. </span>
<span class="sd">		</span>
<span class="sd">		Call this from the target&#39;s constructor. </span>

<span class="sd">		@param item: The item to be added to the implicit inputs. </span>
<span class="sd">		</span>
<span class="sd">			This can be either:</span>
<span class="sd">		</span>
<span class="sd">				- a string, which may contain substitution variables, e.g. ``myparameter=&quot;${someprop}&quot;``, </span>
<span class="sd">				  and will converted to a string using `buildcontext.BuildContext.expandPropertyValues`, or</span>
<span class="sd">				- a callable to be invoked during up-to-dateness checking, that accepts a </span>
<span class="sd">				  context parameter and returns a string or list of strings; </span>
<span class="sd">				  any ``None`` items in the list are ignored. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">callable</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__registeredImplicitInputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>
	
<div class="viewcode-block" id="BaseTarget.getHashableImplicitInputs"><a class="viewcode-back" href="../../autodocgen/xpybuild.basetarget.html#xpybuild.basetarget.BaseTarget.getHashableImplicitInputs">[docs]</a>	<span class="k">def</span> <span class="nf">getHashableImplicitInputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;(deprecated) Target classes can implement this to add the string line(s) as &#39;implicit inputs&#39; of this target. </span>
<span class="sd">		</span>
<span class="sd">		@deprecated: The `registerImplicitInput` or `registerImplicitInputOption` methods should be called </span>
<span class="sd">		instead of overriding this method. </span>

<span class="sd">		The default implementation returns nothing, unless </span>
<span class="sd">		`registerImplicitInput` or `registerImplicitInputOption`</span>
<span class="sd">		have been called (in which case only the resolved paths of the file/directory dependencies will be used). </span>
<span class="sd">		</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__registeredImplicitInputs</span><span class="p">:</span>
			<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__registeredImplicitInputs</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
				<span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;resolveToString&#39;</span><span class="p">):</span> <span class="c1"># if we aren&#39;t delegating to expandPropertyValues to resolve this</span>
					<span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
						<span class="k">continue</span>
					<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
						<span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span> <span class="c1"># assume it&#39;s a list or other iterable</span>
						<span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
							<span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
								<span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">expandPropertyValues</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">result</span>
		<span class="k">return</span> <span class="p">[]</span></div>
	
	<span class="k">def</span> <span class="nf">getTags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
		<span class="sd">&quot;&quot;&quot; .. private:: Not exposed publically as there is no public use case for this. </span>
<span class="sd">		</span>
<span class="sd">		@returns: The list of tags associated with this target. &quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tags</span>

<div class="viewcode-block" id="BaseTarget.disableInFullBuild"><a class="viewcode-back" href="../../autodocgen/xpybuild.basetarget.html#xpybuild.basetarget.BaseTarget.disableInFullBuild">[docs]</a>	<span class="k">def</span> <span class="nf">disableInFullBuild</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Called by build file authors to configure this target to not build in ``all`` mode, so that it will only </span>
<span class="sd">		be built if the target name or tag is specified on the command line (or if pulled in by a dependency).</span>
<span class="sd">		</span>
<span class="sd">		This is useful for targets that perform operations such as configuring developer IDEs which would not be </span>
<span class="sd">		needed in the main build, or for expensive parts of the build that are often not needed such as generation </span>
<span class="sd">		of installers. </span>
<span class="sd">		</span>
<span class="sd">		See also `tag`. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__tags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tags</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="s1">&#39;full&#39;</span><span class="p">})</span>
		<span class="n">init</span> <span class="o">=</span> <span class="n">getBuildInitializationContext</span><span class="p">()</span>
		<span class="n">init</span><span class="o">.</span><span class="n">removeFromTags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;full&#39;</span><span class="p">])</span>
		<span class="k">return</span> <span class="bp">self</span></div>
	
<div class="viewcode-block" id="BaseTarget.clearTags"><a class="viewcode-back" href="../../autodocgen/xpybuild.basetarget.html#xpybuild.basetarget.BaseTarget.clearTags">[docs]</a>	<span class="k">def</span> <span class="nf">clearTags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Called by build file authors to removes all tags other than ``all`` from this target.</span>
<span class="sd">		</span>
<span class="sd">		See `tag`. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">init</span> <span class="o">=</span> <span class="n">getBuildInitializationContext</span><span class="p">()</span>
		<span class="n">init</span><span class="o">.</span><span class="n">removeFromTags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tags</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__tags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;full&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;full&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tags</span> <span class="k">else</span> <span class="p">[]</span>
		<span class="n">init</span><span class="o">.</span><span class="n">registerTags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tags</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="BaseTarget.getOption"><a class="viewcode-back" href="../../autodocgen/xpybuild.basetarget.html#xpybuild.basetarget.BaseTarget.getOption">[docs]</a>	<span class="k">def</span> <span class="nf">getOption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">errorIfNone</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errorIfEmptyString</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Target classes can call this during `run` or `clean` to get the resolved value of a specified option for </span>
<span class="sd">		this target, with optional checking to give a friendly error message if the value is an empty string or None. </span>
<span class="sd">		</span>
<span class="sd">		This is a high-level alternative to reading directly from `self.options`. </span>
<span class="sd">		</span>
<span class="sd">		This method cannot be used while the build files are still being loaded, only during the execution of the targets. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;optionName&#39;</span><span class="p">):</span> <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">optionName</span> <span class="c1"># it&#39;s an Option instance</span>

		<span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Target tried to access an option key that does not exist: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">key</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errorIfNone</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">errorIfEmptyString</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">BuildException</span><span class="p">(</span><span class="s1">&#39;This target requires a value to be specified for option &quot;</span><span class="si">%s</span><span class="s1">&quot; (see basetarget.option or setGlobalOption)&#39;</span><span class="o">%</span><span class="n">key</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v</span></div>

<div class="viewcode-block" id="BaseTarget.option"><a class="viewcode-back" href="../../autodocgen/xpybuild.basetarget.html#xpybuild.basetarget.BaseTarget.option">[docs]</a>	<span class="k">def</span> <span class="nf">option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Called by build file authors to configure this target instance with an override for an option value. </span>
<span class="sd">		</span>
<span class="sd">		This allows target-specific overriding of options. If no override is provided, the value set in </span>
<span class="sd">		`xpybuild.propertysupport.setGlobalOption` for the whole build is used, or if that was not set then the default </span>
<span class="sd">		when the option was defined. </span>
<span class="sd">		</span>
<span class="sd">		Use `self.options` or `getOption` to get resolved option values when implementing a target class. </span>
<span class="sd">		</span>
<span class="sd">		@param str|xpybuild.propertysupport.Option key: The name of a previously-defined option. Usually this is a string </span>
<span class="sd">		literal, but you cna also use the `xpybuild.propertysupport.Option` instance if you prefer. </span>
<span class="sd">		</span>
<span class="sd">		@param value: The value. If the value is a string and contains any property values these will be expanded </span>
<span class="sd">		before the option value is passed to the target. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;optionName&#39;</span><span class="p">):</span> <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">optionName</span> <span class="c1"># it&#39;s an Option instance</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">__optionsTargetOverridesUnresolved</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
		<span class="k">return</span> <span class="bp">self</span></div>
	
<div class="viewcode-block" id="BaseTarget.openFile"><a class="viewcode-back" href="../../autodocgen/xpybuild.basetarget.html#xpybuild.basetarget.BaseTarget.openFile">[docs]</a>	<span class="k">def</span> <span class="nf">openFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">xpybuild</span><span class="o">.</span><span class="n">buildcontext</span><span class="o">.</span><span class="n">BuildContext</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Target classes can call this from their `run` implementation to open a specified file, using an encoding </span>
<span class="sd">		specified by the ``common.fileEncodingDecider`` option (unless explicitly provided by ``encoding=``). </span>
<span class="sd">		</span>
<span class="sd">		@param context: The context that was passed to run().</span>
<span class="sd">		@param path: The full absolute path to be opened. </span>
<span class="sd">		@param mode: The file mode. </span>
<span class="sd">		@keyword kwargs: Any additional arguments for the io.open() method can be specified here. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="s1">&#39;b&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mode</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;encoding&#39;</span><span class="p">):</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;encoding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s1">&#39;common.fileEncodingDecider&#39;</span><span class="p">)(</span><span class="n">context</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">openForWrite</span> <span class="k">if</span> <span class="s1">&#39;w&#39;</span> <span class="ow">in</span> <span class="n">mode</span> <span class="k">else</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">)(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
	
<div class="viewcode-block" id="BaseTarget.tags"><a class="viewcode-back" href="../../autodocgen/xpybuild.basetarget.html#xpybuild.basetarget.BaseTarget.tags">[docs]</a>	<span class="k">def</span> <span class="nf">tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">tags</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Called by build file authors to append one or more tags to this target to make groups of related targets </span>
<span class="sd">		easier to build (or just to provide a shorter alias for the target on the command line).</span>

<span class="sd">		@param tags: The tag, tags or list of tags to add to the target.</span>
<span class="sd">		</span>
<span class="sd">		&gt;&gt;&gt; BaseTarget(&#39;a&#39;,[]).tags(&#39;abc&#39;).getTags()</span>
<span class="sd">		&lt;using test initialization context&gt; &lt;using test initialization context&gt; [&#39;abc&#39;, &#39;full&#39;]</span>
<span class="sd">		&gt;&gt;&gt; BaseTarget(&#39;a&#39;,[]).tags([&#39;abc&#39;, &#39;def&#39;]).getTags()</span>
<span class="sd">		&lt;using test initialization context&gt; &lt;using test initialization context&gt; [&#39;abc&#39;, &#39;def&#39;, &#39;full&#39;]</span>
<span class="sd">		&gt;&gt;&gt; BaseTarget(&#39;a&#39;,[]).tags(&#39;abc&#39;, &#39;def&#39;).tags(&#39;ghi&#39;).getTags()</span>
<span class="sd">		&lt;using test initialization context&gt; &lt;using test initialization context&gt; &lt;using test initialization context&gt; [&#39;ghi&#39;, &#39;abc&#39;, &#39;def&#39;, &#39;full&#39;]</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">taglist</span> <span class="o">=</span> <span class="n">getStringList</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tags</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__tags</span> <span class="o">=</span> <span class="n">taglist</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tags</span>
		<span class="k">assert</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tags</span><span class="p">)))</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tags</span><span class="p">))</span> <span class="c1"># check for duplicates</span>
		<span class="n">init</span> <span class="o">=</span> <span class="n">getBuildInitializationContext</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">init</span><span class="p">:</span> <span class="n">init</span><span class="o">.</span><span class="n">registerTags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">taglist</span><span class="p">)</span> <span class="c1"># init will be None during doctests</span>
		<span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="BaseTarget.priority"><a class="viewcode-back" href="../../autodocgen/xpybuild.basetarget.html#xpybuild.basetarget.BaseTarget.priority">[docs]</a>	<span class="k">def</span> <span class="nf">priority</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">priority</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Called by build file authors to configure the priority of this target to encourage it (and its dependencies) </span>
<span class="sd">		to be built earlier in the process. </span>
<span class="sd">		</span>
<span class="sd">		The default priority is 0.0</span>

<span class="sd">		@param priority: a float representing the priority. Higher numbers will be built</span>
<span class="sd">			first where possible. Cannot be negative. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">priority</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">BuildException</span><span class="p">(</span><span class="s1">&#39;Target priority cannot be set to a lower number than 0.0&#39;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">__priority</span> <span class="o">=</span> <span class="n">priority</span>
		<span class="k">return</span> <span class="bp">self</span></div>

	<span class="k">def</span> <span class="nf">updateStampFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		.. private:: Not useful enough to be in the public API. </span>
<span class="sd">		</span>
<span class="sd">		Assumes self.path is a stamp file that just needs creating / timestamp updating and does so &quot;&quot;&quot;</span>
		<span class="n">path</span> <span class="o">=</span> <span class="n">normLongPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
		<span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
		<span class="k">with</span> <span class="n">openForWrite</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
			<span class="k">pass</span>

	
	<span class="k">def</span> <span class="nf">getPriority</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; .. private:: Not exposed publically as there is no public use case for this. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__priority</span>


<div class="viewcode-block" id="BaseTarget.targetNameToUniqueId"><a class="viewcode-back" href="../../autodocgen/xpybuild.basetarget.html#xpybuild.basetarget.BaseTarget.targetNameToUniqueId">[docs]</a>	<span class="nd">@staticmethod</span>
	<span class="k">def</span> <span class="nf">targetNameToUniqueId</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;Convert a target name (containing unexpanded property values) into a convenient unique identifier. </span>
<span class="sd">		</span>
<span class="sd">		The resulting identifier is not an absolute path, and (unless very long) does not contain any directory </span>
<span class="sd">		elements. This id is suitable for temporary filenames and directories etc</span>
<span class="sd">		</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># remove chars that are not valid on unix/windows file systems (e.g. colon)</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^()+./\w-]+&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;${&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="c1"># avoid deeply nested directories in general</span>
		<span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="BaseTarget.Options"><a class="viewcode-back" href="../../autodocgen/xpybuild.basetarget.html#xpybuild.basetarget.BaseTarget.Options">[docs]</a>	<span class="k">class</span> <span class="nc">Options</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot; Options for customizing the behaviour of all targets. To set an option on a specific target call </span>
<span class="sd">		`xpybuild.basetarget.BaseTarget.option` or to se a global default use `xpybuild.propertysupport.setGlobalOption`. </span>
<span class="sd">		&quot;&quot;&quot;</span>
	
		<span class="n">failureRetries</span> <span class="o">=</span> <span class="n">defineOption</span><span class="p">(</span><span class="s2">&quot;Target.failureRetries&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		The &quot;Target.failureRetries&quot; option can be set on any target (or globally), and specifies how many times to retry </span>
<span class="sd">		the target&#39;s build if it fails. The default is 0, which is recommended for normal developer builds. </span>

<span class="sd">		There is an exponentially increasing backoff pause between each attempt - first 15s, then 30s, then 60s etc. </span>
<span class="sd">		</span>
<span class="sd">		See `xpybuild.buildcommon.registerBuildLoadPostProcessor` which can be used to customize this option for targets based on </span>
<span class="sd">		user-defined criteria such as target type. </span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="n">failureRetriesInitialBackoffSecs</span> <span class="o">=</span> <span class="n">defineOption</span><span class="p">(</span><span class="s1">&#39;Target.failureRetriesInitialBackoffSecs&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span> <span class="c1"># undocumented as there should be no reason to change this</span></div></div>

<span class="n">targetNameToUniqueId</span> <span class="o">=</span> <span class="n">BaseTarget</span><span class="o">.</span><span class="n">targetNameToUniqueId</span> <span class="c1"># alias for pre-3.0 projects</span>
<span class="sd">&quot;&quot;&quot;.. private:: See static method instead.</span>

<span class="sd">.. deprecated:: Use `BaseTarget.targetNameToUniqueId` instead. </span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">from</span> <span class="nn">xpybuild.pathsets</span> <span class="kn">import</span> <span class="n">PathSet</span><span class="p">,</span> <span class="n">BasePathSet</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019-2021, Ben Spiller and Matthew Johnson

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>